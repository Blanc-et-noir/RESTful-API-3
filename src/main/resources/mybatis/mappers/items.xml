<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spring.api.mapper.ItemMapper">
	<resultMap type="com.spring.api.dto.ItemWithItemImageDTO" id="ItemWithItemImageDTOMap">
		<id column="item_id" property="item_id"/>
		<result column="item_name" property="item_name"/>
		<result column="item_description" property="item_description"/>
		<result column="item_price" property="item_price"/>
		<result column="item_number" property="item_number"/>
		<result column="item_time" property="item_time"/>
		<result column="user_id" property="user_id"/>
		<result column="user_name" property="user_name"/>
		<collection property="item_images" javaType="java.util.LinkedList" ofType="com.spring.api.dto.ItemImageDTO">
			<id property="item_image_id" column="item_image_id"/>
			<result column="item_id" property="item_id"/>
			<result property="item_image_original_name" column="item_image_original_name"/>
			<result property="item_image_stored_name" column="item_image_stored_name"/>
			<result property="item_image_extension" column="item_image_extension"/>
			<result property="item_image_size" column="item_image_size"/>
		</collection>
	</resultMap>
	
	<select id="readNewItemId" resultType="Integer">
		SELECT NEXTVAL(seq_item_id)
	</select>
	
	<select id="readItemByItemId" resultType="ItemEntity" parameterType="HashMap">
		SELECT i.*
		FROM items i NATURAL JOIN users u LEFT OUTER JOIN(
			SELECT t.*
			FROM(
				SELECT item_image_id, item_id, ROW_NUMBER() OVER(PARTITION BY item_id ORDER BY item_id ASC) lvl
				FROM item_images
			) t
			WHERE t.lvl = 1
		) m USING(item_id)
		WHERE i.item_id = ${item_id} AND i.item_status = 'N' AND u.user_status = 'N'
	</select>
	
	<select id="readCommentByCommentId" resultType="CommentEntity" parameterType="HashMap">
		SELECT *
		FROM comments NATURAL JOIN users
		WHERE item_id = ${item_id} AND comment_id = ${comment_id} AND comment_status = 'N' AND user_status = 'N'
	</select>
	
	<select id="readItems" resultMap="ItemWithItemImageDTOMap" parameterType="HashMap">
		SELECT *
		FROM items i
		NATURAL JOIN users u
		LEFT OUTER JOIN (SELECT * FROM item_images) m USING(item_id)
		WHERE i.item_status = 'N' AND u.user_status = 'N'
		<if test="hashtags != null">
			AND EXISTS(
				SELECT 1
				FROM hashtags h
				WHERE i.item_id = h.item_id AND REPLACE(h.hashtag_content,' ', '') IN <foreach collection="hashtags" open="(" close=")" item="value" separator=",">REPLACE(#{value},' ', '')</foreach>
			)
		</if>
		ORDER BY i.item_id DESC
		OFFSET ${offset} ROWS FETCH NEXT ${limit} ROWS ONLY
	</select>
	
	<select id="readComments" resultType="CommentEntity" parameterType="HashMap">
		WITH RECURSIVE cte AS(
			SELECT comment_id, parent_comment_id, comment_id "top_comment_id", comment_content, 1 "comment_depth", CAST(LPAD(comment_id,10,0) AS CHAR(300)) "comment_path",comment_time,comment_status, item_id, user_id
			FROM comments
			WHERE item_id = ${item_id} AND parent_comment_id IS NULL
			UNION ALL
			SELECT c1.comment_id, c1.parent_comment_id, c2.top_comment_id, c1.comment_content, c2.comment_depth+1 "comment_depth", CONCAT(c2.comment_path, LPAD(c1.comment_id,10,0)) "comment_path",c1.comment_time,c1.comment_status, c1.item_id, c1.user_id
			FROM comments c1 JOIN cte c2 ON c1.parent_comment_id = c2.comment_id
		)
		SELECT comment_id, parent_comment_id, comment_time, comment_depth, item_id,
			CASE WHEN comment_status = 'Y' THEN '작성자에 의해 삭제된 댓글입니다.' ELSE comment_content END "comment_content",
			CASE WHEN user_status IS NULL OR user_status = 'Y' THEN NULL ELSE user_id END "user_id",
			CASE WHEN user_status IS NULL OR user_status = 'Y' THEN '탈퇴한 사용자' ELSE user_name END "user_name"
		FROM cte LEFT OUTER JOIN users USING(user_id)
		ORDER BY top_comment_id DESC, comment_path ASC
		OFFSET ${offset} ROWS FETCH NEXT ${limit} ROWS ONLY;
	</select>
	
	<insert id="createItem" parameterType="HashMap">
		INSERT INTO items
		VALUES(${item_id},#{item_name},#{item_description},${item_price},${item_number},NOW(),'N',#{user_id})
	</insert>
	
	<insert id="createHashtags" parameterType="HashMap">
		INSERT INTO hashtags(hashtag_content, item_id) VALUES
		<foreach collection="hashtags" separator="," item="value">
			(#{value}, ${item_id})
		</foreach>
	</insert>
	
	<insert id="createItemImages" parameterType="HashMap">
		INSERT INTO item_images VALUES
		<foreach collection="image_files" separator="," item="image">
			(NEXTVAL(seq_item_image_id),#{image.item_image_original_name},#{image.item_image_stored_name},#{image.item_image_extension},${image.item_image_size},'N',${item_id})
		</foreach>
	</insert>
	
	<insert id="createCommentContent" parameterType="HashMap">
		INSERT INTO comments
		VALUES(NEXTVAL(seq_comment_id),NULL,#{comment_content},NOW(),'N',${item_id},#{user_id})
	</insert>
	
	<insert id="createReplyCommentContent" parameterType="HashMap">
		INSERT INTO comments
		VALUES(NEXTVAL(seq_comment_id),${comment_id},#{comment_content},NOW(),'N',${item_id},#{user_id})
	</insert>
	
	<update id="deleteComment" parameterType="HashMap">
		UPDATE comments
		SET comment_status = 'Y'
		WHERE comment_id = ${comment_id} AND user_id = #{user_id} AND comment_status = 'N'
	</update>
	
	<update id="updateComment" parameterType="HashMap">
		UPDATE comments
		SET comment_content = #{comment_content}
		WHERE comment_id = ${comment_id} AND comment_status = 'N' AND user_id = #{user_id} AND item_id = ${item_id}
	</update>
</mapper>